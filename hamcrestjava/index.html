#!/usr/bin/env python2

# MIT license: https://en.wikipedia.org/wiki/MIT_License,

# Copyright (c) 2019, Paul Hammant
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.


import json
import os
import sys
import traceback

import dateutil
import sh
import time
from shutil import copyfile

from udiff import UDiffFileAsJson
from dateutil.parser import parse
import yaml

def calcStatsForCommit():
    convert = udiffasjson.convert(".revpatch")
    lineCount = 0
    tastableLineCount = 0
    testLineCount = 0
    commit = json.loads(convert)
    commit["who"] = who
    commit["when"] = when
    commit["hash"] = revHash
    for chgNum, chg in enumerate(commit["changes"], start=1):
        testable = False
        istest = False
        for testable_file_suffix in cfg['testable-file-suffixes']:
            if chg["from"].endswith(testable_file_suffix) or chg["to"].endswith(testable_file_suffix):
                testable = True
        if '/test' in chg["from"] or '/test' in chg["to"] \
                or 'test/' in chg["from"] or 'test/' in chg["to"] \
                or 'tests/' in chg["from"] or 'tests/' in chg["to"]:
            istest = True
        for chunkNum, chunk in enumerate(chg["chunks"], start=1):
            lineCount += len(chunk["lines"])
            if testable:
                tastableLineCount += len(chunk["lines"])
                if istest:
                    testLineCount += len(chunk["lines"])
    if tastableLineCount > 0 or cfg['write_json_diffs']:
        postStats(year + "/" + month + "/" + day, lineCount, testLineCount, tastableLineCount, revHash, who, when.isoformat())
        postStats(year + "/" + month, lineCount, testLineCount, tastableLineCount, revHash, who, when.isoformat())
        postStats(year, lineCount, testLineCount, tastableLineCount, revHash, who, when.isoformat())
    if cfg['write_json_diffs']:
        with open(filepath, 'w') as rev_diff_json:
            rev_diff_json.writelines(convert)


udiffasjson = UDiffFileAsJson()

stats = {}
years = []
yearMonths = {}

def postStats(d, lineCount, testLineCount, tastableLineCount, revHash, who, when):
    if not tastableLineCount == 0:
        pct = round(testLineCount * 100 / tastableLineCount, 1)
    else:
        pct = 0.0
    if d not in stats:
        stats[d] = {"commits": [], "description": cfg['description'], "baseURL": cfg["base-diff-url"]}
    stats[d]["commits"].append(
        {"id": revHash, "who": who, "when": when, "all": lineCount, "test": testLineCount, "testable": tastableLineCount, "pct": pct})

if len(sys.argv) == 1:
    print("Arg 1 is the path to the repo (checkout) for the metrics")
    exit(1)

metrics_path = sys.argv[1]
if not metrics_path.endswith("/"):
    metrics_path = metrics_path + "/"

cfg = {}
with open(metrics_path + ".commit-bubbles.yml", 'r') as ymlfile:
    cfg = yaml.load(ymlfile, Loader=yaml.FullLoader)

metrics_data_path = metrics_path + "data/"



if 'write_json_diffs' not in cfg:
    cfg["write_json_diffs"] = False

if 'base-diff-url' not in cfg:
    cfg["base-diff-url"] = "https://github.com/?/?/commit/"

if 'description' not in cfg:
    print("'description' list needed in .commit-bubbles.yml")
    exit(1)

if 'redactions' not in cfg:
    cfg["redactions"] = []

if 'testable-file-suffixes' not in cfg:
    print("'testable-file-suffixes' list needed in .commit-bubbles.yml")
    exit(1)

copyfile(sys.argv[0].replace("gen_test_metrics.py", "index.html"), metrics_path + "index.html")

commits = sh.git("log", "--pretty=format:%H %ae %ad", "--date=iso-strict", _tty_out=False)

for commitLine in commits.split("\n"):
    parts = commitLine.replace("(no author)", "no_author").split(" ")
    revHash = parts[0]
    who = parts[1]
    for redaction in cfg['redactions']:
        who = who.replace(redaction, "")
    when = parse(parts[2])
    start = time.time()
    year = str(when.year)
    month = "%02d" % when.month
    day = "%02d" % when.day
    hour = "%02d" % when.hour
    minute = "%02d" % when.minute
    second = "%02d" % when.second
    if year not in years:
        years.append(year)
        yearMonths[year] = []
    if month not in yearMonths[year]:
        yearMonths[year].append(month)
    d = metrics_data_path + year + "/" + month + "/" + day + "/"
    f = d + hour + "-" + minute + "-" + second + "-"
    filepath = f + revHash + ".commit.json"
    if (os.path.isfile(filepath)):
        # print("Skip revision: " + str(revHash) + " duration: " + "%.2f" % ((time.time()-start)*1000) + "ms")
        pass
    else:
        output = sh.git("show", revHash, "--no-prefix", "--first-parent", _tty_out=False)
        output.wait()
        with open('.revpatch', 'w') as revpatch:
            try:
                revpatch.writelines(output.encode('utf-8'))
                if not os.path.isdir(d):
                    os.makedirs(d)
                calcStatsForCommit()
                # print("Good revision: " + str(revHash) + " duration: " + "%.1f" % ((time.time()-start)*1000) + "ms ") # + json.dumps(stats))
            except UnicodeDecodeError:
                print("Commit " + revHash + " causes unicode encoding errors.")

for statNum, path in enumerate(stats, start=1):
    with open(metrics_data_path + path + "/index.json", 'w') as statFile:
        statFile.writelines(json.dumps(stats[path], indent=2))

with open(metrics_data_path + "years.json", 'w') as yrsFile:
    yrsFile.writelines(json.dumps(sorted(years), indent=2))

for year, months in yearMonths.iteritems():
    with open(metrics_data_path + str(year) + "/months.json", 'w') as monthsFile:
        monthsFile.writelines(json.dumps(sorted(months), indent=2))

os.remove('.revpatch')